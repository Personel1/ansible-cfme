- name: clone rbenv
  git: repo=git://github.com/sstephenson/rbenv.git dest=$item/$rbenv_dir force=no
  with_env: HOME

- name: clone ruby rbenv-gemset
  git: repo=git://github.com/jamis/rbenv-gemset.git dest=$item/$rbenv_dir/plugins force=no
  with_env: HOME

  # FIXME: /root hard-coded for this manual install
- name: install rbenv-gemset to /usr/local/bin
  command: cp /root/$rbenv_dir/plugins/rbenv-gemset/libexec/$item /usr/local/bin/ creates=/usr/local/bin/$item
  with_items:
    - rbenv-gemset
    - rbenv-gemset-active
    - rbenv-gemset-create
    - rbenv-gemset-delete
    - rbenv-gemset-file
    - rbenv-gemset-list

- name: clone ruby-build
  git: repo=https://github.com/sstephenson/ruby-build.git dest=$item/$rbenv_dir/plugins/ruby-build force=no
  with_env: HOME

- name: add rbenv to path
  lineinfile: dest=$item/$profile regexp="$rbenv_dir/bin" line="export PATH=$HOME/$rbenv_dir/bin:$PATH"
  with_env: HOME

- name: add rbenv init to path
  lineinfile: dest=$item/$profile regexp="rbenv init" line='eval "$(rbenv init -)"' insertafter=EOF
  with_env: HOME

- name: source path
  action: shell exec $SHELL -l

- name: install ruby-build standalone
  shell: ./install.sh chdir=$item/$rbenv_dir/plugins/ruby-build creates=/usr/local/bin/ruby-build
  with_env: HOME

- name: copy install ruby script
  template: src=templates/install_ruby.sh.j2 dest=/tmp/install_ruby.sh owner=root group=root mode=0755

- name: install ruby
  command: rbenv install $ruby_ver creates=/usr/local/rbenv/versions/$ruby_ver/bin/ruby

- name: rbenv rehash
  command: rbenv rehash

- name: rbenv local
  command: rbenv local $ruby_ver chdir=$vmdb_dir

- name: create gemset cfme
  command: rbenv gemset create $ruby_ver cfme 
  with_env: HOME

- name: install gemset cfme
  command: touch .rbenv-gemsets chdir=$vmdb_dir creates=$vmdb_dir/.rbenv-gemsets

- name: activate gemset
  command: rbenv gemset active chdir=$vmdb_dir

- name: rbenv rehash-b
  command: rbenv rehash chdir=$vmdb_dir

- name: gem install bundler
  gem: name=bundler version=$bundler_ver

- name: rbenv rehash-c
  command: rbenv rehash chdir=$vmdb_dir

- name: bundle install
  command: bundle install --without=development metric_fu test_ui test sqlserver chdir=$vmdb_dir

